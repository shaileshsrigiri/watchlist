<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Watchlist ‚Äî Card Grid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b1020; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --accent:#60a5fa;
      --card:#0f1428; --chip:#1a2544; --overlay:rgba(6,10,22,.72);
      --heroH: 360px; --heroW: calc(var(--heroH) * 2 / 3);
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1020 40%,#0e1630);color:var(--ink)}
    header{position:sticky;top:0;z-index:20;background:rgba(11,16,32,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    h1{margin:6px 0 4px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns:1fr 140px auto auto auto auto auto;gap:8px;align-items:center;margin-top:8px}
    .toolbar > *{min-width:0}
    input,select,textarea{background:#0b1226;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    button,.btn{background:#172554;color:#e5e7eb;border:1px solid var(--line);padding:10px 12px;border-radius:10px;cursor:pointer}
    button:hover,.btn:hover{background:#1e3a8a}
    .btn-ghost{background:transparent}
    .muted{color:var(--muted)}
    @media (max-width:1000px){ .toolbar{grid-template-columns:1fr auto auto auto} }

    /* Grid & lists */
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .list{display:grid;gap:12px}

    /* Chips */
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#1a2544;border:1px solid var(--line);color:#a9b8ff;padding:2px 8px;border-radius:999px;font-size:12px}

    /* Card */
    .item{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;cursor:pointer}
    .poster{position:relative;aspect-ratio:2/3;background:linear-gradient(135deg,#0b1226,#0f1a36);display:flex;align-items:center;justify-content:center}
    .poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .poster .letter{position:absolute;color:#7f92c9;font-weight:800;font-size:54px}
    .titlebar{
      margin:8px 12px 0;
      padding:6px 10px;
      border:1px solid var(--line);
      background:#0b1226;
      border-radius:10px;
      font-weight:700;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta{padding:10px 12px}
    .meta-row{display:flex;align-items:center;gap:8px}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .pill.movie{color:#fca5a5}
    .pill.show{color:#93c5fd}
    .rating{margin-left:auto;background:#10233f;border:1px solid #28436f;padding:2px 8px;border-radius:8px}

    /* Detail */
    .detail{display:none}
    .detail.show{display:block}
    .headbar{display:flex;align-items:center;gap:8px;margin:12px 0}
    .back{background:#172554;border:1px solid var(--line);padding:8px 12px;border-radius:10px}
    .hero{display:flex;gap:16px;padding:14px;background:var(--card);border:1px solid var(--line);border-radius:14px}
    .hero .poster{width:var(--heroW);height:var(--heroH);border-radius:12px;flex:0 0 auto;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:calc(var(--heroH)*.45);color:#7f92c9}
    .hmeta{display:flex;flex-direction:column;gap:8px;flex:1 1 auto;min-width:0}
    .hmeta .row{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
    .facts{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;margin-top:6px}
    .kv b{color:var(--muted);display:inline-block;min-width:90px}
    @media (max-width:900px){ :root{--heroH:300px} }
    @media (max-width:720px){ :root{--heroH:240px} .hero{flex-direction:column;align-items:center} .facts{grid-template-columns:1fr} }

    /* Reco drawer */
    .reco-drawer{position:fixed;top:120px;right:16px;width:340px;max-width:95vw;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.45);padding:12px;display:none;z-index:15;max-height:calc(100vh - 140px);overflow:auto}
    .reco-drawer.open{display:block}
    .reco-item{display:flex;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0f1428;align-items:center}
    .reco-poster{width:48px;height:72px;background:#101a34;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#5b6c94;font-size:12px}

    /* FAB + Modal (Add) */
    .fab{position:fixed;right:24px;bottom:24px;background:var(--accent);color:#06121f;border-color:#274c7a;padding:14px 16px;border-radius:14px;font-weight:600;z-index:16}

    /* modal (Add sheet) */
    .overlay{
      position:fixed; inset:0;
      background:var(--overlay);
      display:none; align-items:flex-end; justify-content:center;
      z-index:30;
      overscroll-behavior:contain;
    }
    .overlay.open{ display:flex; }

    .sheet{
      width:100%; max-width:900px;
      background:var(--panel); border:1px solid var(--line);
      border-top-left-radius:16px; border-top-right-radius:16px;
      box-shadow:0 -10px 30px rgba(0,0,0,.5);
      max-height:92vh;
      display:flex; flex-direction:column;
    }
    .sheet .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:3; background:var(--panel);
    }
    .tabs{
      display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid var(--line);
      position:sticky; top:48px; z-index:2; background:var(--panel);
    }
    .tab{ padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#0b1226; cursor:pointer }
    .tab.active{ background:#1e2a52 }

    .sheet .body{
      padding:12px 16px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    #tab-tmdb .row-2{
      position:sticky; top:0; z-index:1;
      background:var(--panel);
      padding-top:4px; padding-bottom:8px;
      border-bottom:1px solid var(--line);
    }
    .row-2{display:grid;grid-template-columns:1fr auto;gap:8px}
    .list-compact .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0f1428}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üé¨ Watchlist ‚Äî Card Grid</h1>
    <div class="sub">Minimal cards (poster + title overlay). Click a card for details. Fully offline with Import/Export.</div>

    <div class="toolbar">
      <input id="omni" placeholder='Search anything‚Ä¶ e.g. nolan actor:"anne hathaway" genre:sci-fi year:>=2010 imdb:>=8 unwatched' />
      <select id="sortSel">
        <option value="imdb-desc">Sort: IMDb ‚¨áÔ∏é</option>
        <option value="year-desc">Year ‚¨áÔ∏é</option>
        <option value="year-asc">Year ‚¨ÜÔ∏é</option>
        <option value="title-asc">Title A‚ÄìZ</option>
        <option value="added-desc">Recently Added</option>
      </select>
      <label class="muted"><input id="chkUnwatched" type="checkbox" /> Unwatched</label>

      <button id="btnReco">Recommendations</button>
      <button id="btn-export" title="Download JSON">Export</button>
      <label class="btn" id="btn-import">Import
        <input id="file-import" type="file" accept="application/json" hidden>
      </label>
      <button id="btn-clear" class="btn-ghost" title="Clear all items (confirm)">Clear</button>
    </div>

    <div id="activeFilters" class="chips" style="margin-top:6px"></div>
  </div>
</header>

<main class="wrap" style="margin-top:12px">
  <!-- GRID -->
  <section id="view-grid" class="grid">
    <div id="grid-cards" class="list cards"></div>
  </section>

  <!-- DETAIL -->
  <section id="view-detail" class="detail">
    <div class="headbar">
      <button id="btnBack" class="back">‚Üê Back</button>
      <strong id="dt-breadcrumb" class="muted"></strong>
    </div>
    <div class="hero">
      <div id="dt-poster" class="poster">P</div>
      <div class="hmeta">
        <div class="row">
          <h2 id="dt-title" style="margin:0"></h2>
          <span id="dt-year" class="muted"></span>
          <span id="dt-type" class="pill"></span>
          <span id="dt-imdb" class="pill"></span>
        </div>
        <div id="dt-genres" class="chips"></div>
        <div id="dt-overview" class="muted"></div>
        <div class="row" style="gap:8px">
          <button id="dt-watch">Mark Watched</button>
          <button id="dt-edit" class="btn-ghost">Edit</button>
          <button id="dt-del" class="btn-ghost">Delete</button>
        </div>
        <div class="facts">
          <div class="kv"><b>Director:</b> <span id="dt-director"></span></div>
          <div class="kv"><b>Added:</b> <span id="dt-added"></span></div>
          <div class="kv"><b>Cast:</b> <span id="dt-cast"></span></div>
          <div class="kv"><b>Status:</b> <span id="dt-status"></span></div>
          <div class="kv" style="grid-column:1/-1"><b>Production:</b> <span id="dt-prod"></span></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Recommendations Drawer -->
<aside id="reco" class="reco-drawer" aria-live="polite">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <strong>Top Picks</strong>
    <select id="recoScope" style="width:160px">
      <option value="unwatched">Unwatched</option>
      <option value="all">All items</option>
    </select>
  </div>
  <div id="recoList" class="list"></div>
</aside>

<!-- FAB Add -->
<button id="btnAdd" class="fab">Ôºã Add</button>

<!-- Add Modal -->
<div id="modal" class="overlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="head">
      <strong>Add a Title</strong>
      <button id="closeModal" class="btn-ghost">Close</button>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="tmdb">Search TMDb</button>
      <button class="tab" data-tab="manual">Manual</button>
    </div>
    <div class="body">
      <!-- TMDb -->
      <div id="tab-tmdb">
        <div class="row-2">
          <input id="tmdb-query" placeholder="Type a title, e.g., Inception" />
          <button id="btn-tmdb-search">Search</button>
        </div>
        <div id="tmdb-results" class="list list-compact" style="margin-top:10px"></div>
      </div>
      <!-- Manual -->
      <div id="tab-manual" style="display:none">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <input id="in-title" placeholder="Title *" />
          <select id="in-type"><option value="movie">Movie</option><option value="show">Show</option></select>
          <input id="in-year" type="number" placeholder="Year" />
          <input id="in-director" placeholder="Director(s)" />
          <input id="in-imdb" type="number" min="0" max="10" step="0.1" placeholder="IMDb (0‚Äì10)" />
          <input id="in-genres" placeholder="Genres (comma separated)" />
          <textarea id="in-notes" rows="3" placeholder="Notes (optional)" style="grid-column:1/-1"></textarea>
        </div>
        <div class="toolbar" style="margin-top:10px;justify-content:flex-end">
          <label class="muted" style="display:flex;align-items:center;gap:6px"><input id="in-watched" type="checkbox" /> Mark watched</label>
          <button id="btn-add">Add</button>
        </div>
        <div id="addMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<script src="env.js"></script>
<script>
/* ====================== IndexedDB ====================== */
const DB='watchlist-db-v1', STORE='items'; let db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=e=>{const s=e.target.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});s.createIndex('addedAt','addedAt');s.createIndex('title','title');s.createIndex('imdb','imdb');s.createIndex('watched','watched');};r.onsuccess=()=>{db=r.result;res();};r.onerror=()=>rej(r.error);});}
function tx(mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE);}
const addItem=v=>new Promise((res,rej)=>{const r=tx('readwrite').add(v);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});
const updateItem=v=>new Promise((res,rej)=>{const r=tx('readwrite').put(v);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});
const deleteItemById=id=>new Promise((res,rej)=>{const r=tx('readwrite').delete(id);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});
const deleteAll=()=>new Promise((res,rej)=>{const r=tx('readwrite').clear();r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});
const getAll=()=>new Promise((res,rej)=>{const r=tx().getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});

/* ====================== State & helpers ====================== */
let items=[];
const $=sel=>document.querySelector(sel);
const list=$('#grid-cards');

function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function norm(s){return (s??'').trim().toLowerCase().replace(/\s+/g,' ');}
function firstLetter(s){return (s||'?').trim().charAt(0).toUpperCase()||'?';}
function keyTitleYear(it){return `${norm(it.title)}|${it.year??''}`;}
function existsByIds(c){const imdb=norm(c.imdbId), tmdb=c.tmdbId??null, key=keyTitleYear(c); return items.some(x => (imdb && norm(x.imdbId)===imdb) || (tmdb && x.tmdbId===tmdb) || keyTitleYear(x)===key);}

/* ====================== Omnibox parser ====================== */
function tokenize(q){const out=[];q.replace(/"([^"]+)"|(\S+)/g,(_,a,b)=>out.push(a||b));return out;}
function parseOmni(q){
  const tks = tokenize((q||'').trim());
  const res = {text:[],dir:[],actor:[],prod:[],genre:[],country:[],type:null,yearMin:null,yearMax:null,imdbMin:null,imdbMax:null,watched:null};
  const add=(k,v)=>{if(v) res[k].push(v.toLowerCase());};
  const asNum = s=>{const n=parseFloat(s);return isNaN(n)?null:n;};
  const kmap={director:'dir',dir:'dir',actor:'actor',cast:'actor',prod:'prod',production:'prod',studio:'prod',genre:'genre',g:'genre',country:'country',c:'country',type:'type',t:'type',year:'year',y:'year',imdb:'imdb',rating:'imdb',watched:'watched'};
  for (const tk of tks){
    const m = tk.match(/^(\w+):(.*)$/);
    if(!m){
      const w=tk.toLowerCase();
      if(w==='unwatched') res.watched=false; else if(w==='watched') res.watched=true; else res.text.push(w);
      continue;
    }
    const key=kmap[m[1].toLowerCase()]||m[1].toLowerCase();
    let val=m[2];
    if((val.startsWith('"')&&val.endsWith('"'))||(val.startsWith("'")&&val.endsWith("'"))) val=val.slice(1,-1);

    if(key==='type'){ res.type = val.toLowerCase().startsWith('s')?'show':val.toLowerCase().startsWith('m')?'movie':null; continue; }
    if(key==='watched'){ res.watched = (val.toLowerCase().startsWith('y')||val==='1'||val==='true'); continue; }

    if(key==='year' || key==='imdb'){
      const range = val.match(/^(\d{1,4})-(\d{1,4})$/);
      const gte = val.match(/^>=\s*([0-9.]+)$/), lte = val.match(/^<=\s*([0-9.]+)$/),
            gt  = val.match(/^>\s*([0-9.]+)$/),  lt  = val.match(/^<\s*([0-9.]+)$/),
            eq  = val.match(/^=\s*([0-9.]+)$/) || val.match(/^([0-9.]+)$/);
      if(range){ const lo=asNum(range[1]), hi=asNum(range[2]); if(key==='year'){res.yearMin=lo;res.yearMax=hi;} else {res.imdbMin=lo;res.imdbMax=hi;} }
      else if(gte){ if(key==='year') res.yearMin=asNum(gte[1]); else res.imdbMin=asNum(gte[1]); }
      else if(lte){ if(key==='year') res.yearMax=asNum(lte[1]); else res.imdbMax=asNum(lte[1]); }
      else if(gt){ const n=asNum(gt[1]); if(key==='year') res.yearMin = n!=null?n+1:null; else res.imdbMin=n; }
      else if(lt){ const n=asNum(lt[1]); if(key==='year') res.yearMax = n!=null?n-1:null; else res.imdbMax=n; }
      else if(eq){ const n=asNum(eq[1]); if(key==='year'){res.yearMin=n;res.yearMax=n;} else {res.imdbMin=n;res.imdbMax=n;} }
      continue;
    }
    if(key==='dir') add('dir',val);
    else if(key==='actor') add('actor',val);
    else if(key==='prod') add('prod',val);
    else if(key==='genre') add('genre',val);
    else if(key==='country') add('country',val);
    else res.text.push(`${key}:${val}`.toLowerCase());
  }
  return res;
}
function includesAll(hayArr, needles){
  if(!needles.length) return true;
  const H=(hayArr||[]).map(s=>(s||'').toLowerCase());
  return needles.every(n=>H.some(h=>h.includes(n)));
}

/* ====================== Filters ====================== */
function renderActiveFiltersChips(q, forceUnwatched){
  const chips=[];
  const push = (l,vals)=>vals.forEach(v=>chips.push(`<span class="chip">${l}:${escapeHTML(v)}</span>`));
  q.text.forEach(t=>chips.push(`<span class="chip">${escapeHTML(t)}</span>`));
  push('dir',q.dir); push('actor',q.actor); push('prod',q.prod); push('genre',q.genre); push('country',q.country);
  if(q.type) chips.push(`<span class="chip">type:${escapeHTML(q.type)}</span>`);
  if(q.yearMin!=null || q.yearMax!=null) chips.push(`<span class="chip">year:${q.yearMin??''}-${q.yearMax??''}</span>`);
  if(q.imdbMin!=null || q.imdbMax!=null) chips.push(`<span class="chip">imdb:${q.imdbMin??''}-${q.imdbMax??''}</span>`);
  if(forceUnwatched || q.watched===false) chips.push(`<span class="chip">unwatched</span>`);
  if(q.watched===true) chips.push(`<span class="chip">watched</span>`);
  $('#activeFilters').innerHTML = chips.join('');
}

let currentFilteredArray = [];
/* virtualized grid settings */
const VIRTUAL_THRESHOLD = 120;
const BATCH = 40;
let visibleCount = 0;
let io = null;

function applyFilters(){
  const q=parseOmni($('#omni').value);
  const forceUnwatched = $('#chkUnwatched').checked;
  const sort=$('#sortSel').value;

  let out = items.filter(it=>{
    if(forceUnwatched || q.watched===false){ if(it.watched) return false; }
    if(q.watched===true && !it.watched) return false;
    if(q.type && it.type!==q.type) return false;

    if(q.yearMin!=null && (it.year??-Infinity) < q.yearMin) return false;
    if(q.yearMax!=null && (it.year?? Infinity) > q.yearMax) return false;

    const imdb = (it.imdb==null?-Infinity:it.imdb);
    if(q.imdbMin!=null && imdb < q.imdbMin) return false;
    if(q.imdbMax!=null && imdb > q.imdbMax) return false;

    if(!includesAll([it.director], q.dir)) return false;
    if(!includesAll(it.cast, q.actor)) return false;
    if(!includesAll(it.production, q.prod)) return false;
    if(!includesAll(it.genres, q.genre)) return false;
    if(!includesAll(it.countries, q.country)) return false;

    if(q.text.length){
      const hay = [
        it.title, it.director,
        ...(it.cast||[]), ...(it.production||[]), ...(it.genres||[]), ...(it.countries||[])
      ].filter(Boolean).map(s=>s.toLowerCase());
      for(const term of q.text){ if(!hay.some(h=>h.includes(term))) return false; }
    }
    return true;
  });

  out.sort((a,b)=>{
    switch(sort){
      case 'imdb-desc': return (b.imdb??-1)-(a.imdb??-1);
      case 'year-desc': return (b.year??0)-(a.year??0);
      case 'year-asc' : return (a.year??0)-(b.year??0);
      case 'title-asc': return a.title.localeCompare(b.title);
      case 'added-desc':return (b.addedAt??0)-(a.addedAt??0);
      default: return 0;
    }
  });

  currentFilteredArray = out;
  renderGrid(out);
  renderActiveFiltersChips(q, forceUnwatched);
}

/* ====================== Poster helpers (responsive + lazy) ================= */
function posterImgHTML(it, slot='grid'){
  // Prefer posterPath (TMDb); fallback to posterUrl
  const p = it.posterPath;
  if (p) {
    // sizes tuned for grid (min card 220px), detail hero, or reco thumbs
    const sizes = slot==='detail'
      ? '(max-width: 720px) 80vw, 360px'
      : slot==='reco'
        ? '72px'
        : '(max-width: 640px) 45vw, 220px';
    const w185 = `https://image.tmdb.org/t/p/w185${p}`;
    const w342 = `https://image.tmdb.org/t/p/w342${p}`;
    const w500 = `https://image.tmdb.org/t/p/w500${p}`;
    return `<img
      src="${w342}"
      srcset="${w185} 185w, ${w342} 342w, ${w500} 500w"
      sizes="${sizes}"
      loading="lazy" decoding="async" alt=""
      onerror="this.remove()">`;
  } else if (it.posterUrl) {
    return `<img src="${escapeHTML(it.posterUrl)}" loading="lazy" decoding="async" alt="" onerror="this.remove()">`;
  }
  return '';
}

/* ====================== Grid / Cards ====================== */
function cardHTML(it){
  const chip = `<span class="pill ${it.type==='show'?'show':'movie'}">${it.type||'movie'}</span>`;
  const poster = posterImgHTML(it, 'grid') || '';
  const letter = `<span class="letter">${firstLetter(it.title)}</span>`;
  return `<div class="item" data-id="${it.id}">
    <div class="poster">${poster}${letter}</div>
    <div class="titlebar" title="${escapeHTML(it.title)}">${escapeHTML(it.title)}</div>
    <div class="meta"><div class="meta-row">
      <span class="muted">${it.year??''}</span>
      ${it.imdb!=null?`<span class="rating">IMDb ${it.imdb}</span>`:''}
      ${chip}
    </div></div>
  </div>`;
}

function renderGrid(arr){
  // small lists ‚Üí normal render; big lists ‚Üí virtualized
  if (io) { io.disconnect(); io = null; }
  const sentinel = document.getElementById('sentinel');
  if (sentinel) sentinel.remove();

  if (arr.length <= VIRTUAL_THRESHOLD) {
    list.innerHTML = arr.map(cardHTML).join('') || `<div class="muted">No items yet. Click ‚ÄúÔºã Add‚Äù.</div>`;
    return;
  }

  // virtual start
  visibleCount = Math.min(60, arr.length);
  list.innerHTML = arr.slice(0, visibleCount).map(cardHTML).join('');
  let s = document.createElement('div');
  s.id = 'sentinel';
  s.style.height = '1px';
  list.after(s);

  io = new IntersectionObserver((entries)=>{
    if (!entries.some(e=>e.isIntersecting)) return;
    const prev = visibleCount;
    visibleCount = Math.min(visibleCount + BATCH, currentFilteredArray.length);
    if (visibleCount > prev) {
      list.insertAdjacentHTML('beforeend', currentFilteredArray.slice(prev, visibleCount).map(cardHTML).join(''));
    }
    if (visibleCount >= currentFilteredArray.length) { io.disconnect(); }
  });
  io.observe(s);
}

/* ====================== Routing / Detail ====================== */
function showGrid(){ $('#view-grid').style.display='grid'; $('#view-detail').classList.remove('show'); }
function openDetailById(id){
  const it=items.find(x=>x.id===id); if(!it){ showGrid(); return; }
  $('#dt-breadcrumb').textContent=`${(it.type==='show')?'Show':'Movie'} ‚Ä∫ ${it.title}`;
  $('#dt-title').textContent=it.title;
  $('#dt-year').textContent=it.year?`(${it.year})`:'';
  $('#dt-type').textContent=it.type||'movie';
  $('#dt-imdb').textContent=it.imdb!=null?`IMDb ${it.imdb}`:'';
  $('#dt-genres').innerHTML=(it.genres||[]).map(g=>`<span class="chip">${escapeHTML(g)}</span>`).join(' ');
  $('#dt-overview').textContent=it.notes||'‚Äî';
  $('#dt-director').textContent=it.director||'‚Äî';
  $('#dt-cast').textContent=(it.cast||[]).join(', ') || '‚Äî';
  $('#dt-prod').textContent=(it.production||[]).join(', ') || '‚Äî';
  $('#dt-added').textContent=new Date(it.addedAt||Date.now()).toLocaleDateString();
  $('#dt-status').textContent=it.watched?'Watched':'Unwatched';
  $('#dt-poster').innerHTML = posterImgHTML(it, 'detail') || firstLetter(it.title);

  $('#dt-watch').textContent=it.watched?'Mark Unwatched':'Mark Watched';
  $('#dt-watch').onclick=async()=>{ it.watched=!it.watched; await updateItem(it); items=await getAll(); applyFilters(); openDetailById(id); };
  $('#dt-edit').onclick=async()=>{
    const t=prompt('Title',it.title)??it.title;
    const y=prompt('Year',it.year??'')??it.year;
    const d=prompt('Director(s)',it.director??'')??it.director;
    const r=prompt('IMDb (0‚Äì10)',it.imdb??'')??it.imdb;
    const g=prompt('Genres (comma separated)',(it.genres||[]).join(', '))??(it.genres||[]).join(', ');
    const n=prompt('Notes',it.notes??'')??it.notes;
    Object.assign(it,{title:t.trim()||it.title,year:parseInt(y,10)||null,director:(d||'').trim()||null,imdb:(r!==''?parseFloat(r):null),genres:g.split(',').map(s=>s.trim()).filter(Boolean),notes:(n||'').trim()||null});
    await updateItem(it); items=await getAll(); applyFilters(); openDetailById(id);
  };
  $('#dt-del').onclick=async()=>{ if(!confirm(`Delete "${it.title}"?`)) return; await deleteItemById(id); items=await getAll(); location.hash=''; applyFilters(); };

  $('#view-grid').style.display='none'; $('#view-detail').classList.add('show');
}
function route(){ const h=location.hash||''; if(h.startsWith('#d-')){ const id=parseInt(h.slice(3),10); if(!isNaN(id)) return openDetailById(id); } showGrid(); }
window.addEventListener('hashchange', route);
$('#btnBack').addEventListener('click', ()=>{ if(location.hash.startsWith('#d-')){ history.back(); setTimeout(()=>{ if(location.hash.startsWith('#d-')) location.hash=''; },0); } else { location.hash=''; }});

/* Card click -> detail */
list.addEventListener('click', e=>{ const card=e.target.closest('.item'); if(!card) return; location.hash=`#d-${parseInt(card.dataset.id,10)}`; });

/* ====================== Import/Export/Clear ====================== */
$('#btn-export').addEventListener('click',async()=>{
  const data=await getAll(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=Object.assign(document.createElement('a'),{href:url,download:'watchlist.json'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#file-import').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const arr=JSON.parse(await f.text()); if(!Array.isArray(arr)) throw new Error('Invalid file');
    await deleteAll(); for(const x of arr){ const {id,...rest}=x; await addItem({...rest,addedAt:Date.now()}); }
    items=await getAll(); applyFilters(); route();
  }catch(err){ alert('Import failed: '+err.message); } finally{ e.target.value=''; }
});
$('#btn-clear').addEventListener('click',async()=>{ if(!confirm('Delete all items?')) return; await deleteAll(); items=[]; applyFilters(); route(); });

/* ====================== Recommendations (drawer) ====================== */
function computeRecs(scope='unwatched'){
  const liked = items.filter(x => (x.imdb??0) >= 7);
  const seed = liked.length ? liked : items;
  const gFreq=new Map(), dFreq=new Map();
  seed.forEach(x=>{ (x.genres||[]).forEach(g=>gFreq.set(g,(gFreq.get(g)||0)+1)); if(x.director) dFreq.set(x.director,(dFreq.get(x.director)||0)+1); });
  function score(it){
    const gs=(it.genres||[]).reduce((a,g)=>a+(gFreq.get(g)||0),0);
    const ds=dFreq.get(it.director)||0;
    const imdb=(it.imdb??0)*0.7;
    const bonus=it.watched?-3:3;
    return gs+ds+imdb+bonus;
  }
  let pool = items.slice();
  if(scope==='unwatched') pool = pool.filter(x=>!x.watched);
  return pool.sort((a,b)=>score(b)-score(a)).slice(0,8);
}
function renderRecs(){
  const scope = $('#recoScope').value;
  const recs = computeRecs(scope);
  $('#recoList').innerHTML = recs.map(it=>`
    <div class="reco-item">
      <div class="reco-poster">
        ${posterImgHTML(it,'reco') || 'Img'}
      </div>
      <div>
        <strong>${escapeHTML(it.title)}</strong>
        <div class="muted">${it.type==='show'?'Show':'Movie'} ‚Ä¢ ${it.year??'‚Äî'} ‚Ä¢ ${it.imdb!=null?`IMDb ${it.imdb}`:'No rating'}</div>
      </div>
      <div style="margin-left:auto"><button class="btn-ghost" onclick="location.hash='#d-${it.id}'">Open</button></div>
    </div>
  `).join('') || `<div class="muted">Add a few items to see picks.</div>`;
}
$('#btnReco').onclick=()=>{ $('#reco').classList.toggle('open'); renderRecs(); };
$('#recoScope').onchange=renderRecs;

/* ====================== Add Modal (TMDb + Manual) ====================== */
const modal = $('#modal');
const tabs  = [...document.querySelectorAll('.tab')];

/* scroll-lock helper */
const lockScroll = (on) => {
  const docEl = document.documentElement;
  if (on) {
    const needsComp = window.innerWidth > docEl.clientWidth;
    const comp = needsComp ? (window.innerWidth - docEl.clientWidth) : 0;
    docEl.style.overflow = 'hidden';
    if (comp) docEl.style.paddingRight = comp + 'px';
  } else {
    docEl.style.overflow = '';
    docEl.style.paddingRight = '';
  }
};

$('#btnAdd').onclick = () => {
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
  lockScroll(true);
  const q = document.getElementById('tmdb-query');
  if (q) q.focus();
};
$('#closeModal').onclick = () => {
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden', 'true');
  lockScroll(false);
};
modal.addEventListener('click', (e) => { if (e.target === modal) $('#closeModal').click(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('open')) $('#closeModal').click(); });
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  ['tmdb', 'manual'].forEach(n => document.getElementById('tab-' + n).style.display = (t.dataset.tab === n) ? 'block' : 'none');
}));

function numOrNull(v){const n=parseFloat(v);return isNaN(n)?null:n;}
function blankToNull(v){const s=(v||'').trim();return s||null;}
function normalizeGenres(s){return (s||'').split(',').map(g=>g.trim()).filter(Boolean);}

$('#btn-add').addEventListener('click', async ()=>{
  const title=$('#in-title').value.trim(); if(!title){ $('#addMsg').textContent='Title is required.'; return; }
  const it={
    type: $('#in-type').value, title,
    year: parseInt($('#in-year').value,10)||null,
    director: blankToNull($('#in-director').value),
    imdb: numOrNull($('#in-imdb').value),
    genres: normalizeGenres($('#in-genres').value),
    notes: blankToNull($('#in-notes').value),
    watched: $('#in-watched').checked,
    imdbId:null, tmdbId:null, posterUrl:null, posterPath:null,
    cast:[], production:[], countries:[],
    addedAt: Date.now()
  };
  if(existsByIds(it)){ $('#addMsg').textContent='Already in your list ‚úã'; setTimeout(()=>$('#addMsg').textContent='',1400); return; }
  await addItem(it); items=await getAll(); applyFilters(); $('#addMsg').textContent='Added ‚úî'; setTimeout(()=>$('#addMsg').textContent='',1200);
  ['in-title','in-year','in-director','in-imdb','in-genres','in-notes'].forEach(id=>document.getElementById(id).value=''); $('#in-watched').checked=false; $('#in-type').value='movie';
});

/* ====================== TMDb / OMDb integration ====================== */
const TMDB_KEY=(window.APP_KEYS&&window.APP_KEYS.TMDB)||''; const OMDB_KEY=(window.APP_KEYS&&window.APP_KEYS.OMDB)||'';
const TMDB_API='https://api.themoviedb.org/3';
if(!TMDB_KEY) console.warn('TMDb API key missing. Add it in env.js');

let tmdbCtrl;
const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

async function tmdbSearch(query, { signal } = {}){
  const url=`${TMDB_API}/search/multi?api_key=${encodeURIComponent(TMDB_KEY)}&query=${encodeURIComponent(query)}&include_adult=false`;
  const r=await fetch(url, { signal }); if(!r.ok) throw new Error('TMDb search failed');
  const data=await r.json(); return (data.results||[]).filter(x=>x.media_type==='movie'||x.media_type==='tv').slice(0,10);
}
async function tmdbDetails(kind,id){
  const url=`${TMDB_API}/${kind}/${id}?api_key=${encodeURIComponent(TMDB_KEY)}&append_to_response=credits,external_ids`;
  const r=await fetch(url); if(!r.ok) throw new Error('TMDb details failed'); return r.json();
}
async function fetchImdbRating(imdbId){
  if(!imdbId || !OMDB_KEY) return null;
  const r=await fetch(`https://www.omdbapi.com/?apikey=${encodeURIComponent(OMDB_KEY)}&i=${encodeURIComponent(imdbId)}`);
  if(!r.ok) return null; const d=await r.json(); const val=parseFloat(d.imdbRating); return isNaN(val)?null:val;
}

async function runTmdbSearch(){
  const q=$('#tmdb-query').value.trim(); if(!q) return;
  if (tmdbCtrl) tmdbCtrl.abort();
  tmdbCtrl = new AbortController();
  const container=$('#tmdb-results'); container.innerHTML='<div class="muted">Searching‚Ä¶</div>';
  try{
    const results=await tmdbSearch(q, { signal: tmdbCtrl.signal });
    if(!results.length){ container.innerHTML='<div class="muted">No results.</div>'; return; }
    const img = (path)=> path ? `
      <img
        src="https://image.tmdb.org/t/p/w185${path}"
        srcset="
          https://image.tmdb.org/t/p/w92${path} 92w,
          https://image.tmdb.org/t/p/w154${path} 154w,
          https://image.tmdb.org/t/p/w185${path} 185w"
        sizes="(max-width: 640px) 25vw, 48px"
        loading="lazy" decoding="async" alt=""
        style="width:44px; height:66px; object-fit:cover; border-radius:8px">` : '';

    container.innerHTML = results.map(r=>{
      const title=r.title||r.name, year=(r.release_date||r.first_air_date||'').slice(0,4);
      return `<div class="item">
        <div style="display:flex;gap:10px;align-items:center">
          ${img(r.poster_path)}
          <div><strong>${escapeHTML(title)}</strong> ${year?`<small>(${year})</small>`:''}<div class="muted">${r.media_type.toUpperCase()}</div></div>
        </div>
        <button class="btn-ghost" data-import="${r.media_type}:${r.id}">Add</button>
      </div>`;
    }).join('');
    [...container.querySelectorAll('[data-import]')].forEach(b=>{
      const [k,i]=b.dataset.import.split(':'); const dup=items.some(x=>x.tmdbId===parseInt(i,10)&&x.type===(k==='tv'?'show':'movie')); if(dup){ b.disabled=true; b.textContent='Added'; }
    });
  }catch(e){
    if (e.name !== 'AbortError') container.innerHTML='<div class="muted">Search failed.</div>';
  }
}
$('#btn-tmdb-search').addEventListener('click', runTmdbSearch);
document.getElementById('tmdb-query').addEventListener('input', debounce(runTmdbSearch, 350));

document.getElementById('tmdb-results').addEventListener('click', async e=>{
  const btn=e.target.closest('[data-import]'); if(!btn) return;
  const [kind,idStr]=btn.dataset.import.split(':'), id=parseInt(idStr,10);
  try{
    const d=await tmdbDetails(kind,id);
    let director=null;
    if(kind==='movie'){ const dir=(d.credits?.crew||[]).find(p=>p.job==='Director'); director=dir?dir.name:null; }
    else if(kind==='tv'){ director=(d.created_by||[]).map(x=>x.name).join(', ') || null; }
    const cast=(d.credits?.cast||[]).slice(0,10).map(p=>p.name);
    const production=(d.production_companies||[]).map(p=>p.name);
    const countries=(d.production_countries||[]).map(c=>c.iso_3166_1 || c.name);
    const posterPath=d.poster_path||null;
    const posterUrl= posterPath ? `https://image.tmdb.org/t/p/w342${posterPath}` : null;
    const imdbId=d.external_ids?.imdb_id||null;
    const imdb=(await fetchImdbRating(imdbId)) ?? (typeof d.vote_average==='number'?Math.round(d.vote_average*10)/10:null);
    const item={
      type: kind==='tv'?'show':'movie',
      title: d.title||d.name,
      year: parseInt((d.release_date||d.first_air_date||'').slice(0,4),10)||null,
      director, imdb, genres:(d.genres||[]).map(g=>g.name),
      notes: d.overview || null,
      posterUrl, posterPath, watched:false, imdbId, tmdbId:d.id, addedAt: Date.now(),
      cast, production, countries
    };
    if(existsByIds(item)){ alert('Already in your list.'); return; }
    await addItem(item); items=await getAll(); applyFilters(); document.getElementById('addMsg').textContent='Added from TMDb ‚úî'; setTimeout(()=>document.getElementById('addMsg').textContent='',1200);
  }catch(err){ alert('Import failed: '+err.message); }
});

/* ====================== Bind inputs ====================== */
document.getElementById('omni').addEventListener('input', applyFilters);
document.getElementById('sortSel').addEventListener('change', applyFilters);
document.getElementById('chkUnwatched').addEventListener('change', applyFilters);

/* ====================== Service Worker ====================== */
function registerSW(){ if(!('serviceWorker' in navigator)) return; navigator.serviceWorker.register('sw.js').catch(()=>{}); }

/* ====================== Boot ====================== */
(async function boot(){
  await openDB();
  items = await getAll();
  applyFilters();
  route();
  registerSW();
})();
</script>
</body>
</html>
